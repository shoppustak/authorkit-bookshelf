let currentPage=1,currentGenre=null,currentSearch="",currentSort="latest",totalPages=1;function setupEventListeners(){document.getElementById("search-input").addEventListener("input",debounce(e=>{currentSearch=e.target.value,currentPage=1,updateUrlParams({search:currentSearch,page:currentPage}),loadBooks()},500));const e=document.querySelectorAll('input[name="genre"]');e.forEach(t=>{t.addEventListener("change",t=>{if("all"===t.target.value)e.forEach(e=>{"all"!==e.value&&(e.checked=!1)}),currentGenre=null;else{document.querySelector('input[name="genre"][value="all"]').checked=!1;const n=Array.from(e).filter(e=>e.checked&&"all"!==e.value).map(e=>e.value);e.forEach(e=>{"all"!==e.value&&e.value!==t.target.value&&(e.checked=!1)}),currentGenre=n[0]||null}currentPage=1,updateUrlParams({genre:currentGenre,page:currentPage}),loadBooks()})});document.getElementById("sort-select").addEventListener("change",e=>{currentSort=e.target.value,currentPage=1,updateUrlParams({sort:currentSort,page:currentPage}),loadBooks()});document.getElementById("reset-filters").addEventListener("click",()=>{currentGenre=null,currentSearch="",currentSort="latest",currentPage=1,document.getElementById("search-input").value="",document.getElementById("sort-select").value="latest",document.querySelectorAll('input[name="genre"]').forEach(e=>{e.checked="all"===e.value}),updateUrlParams({genre:null,search:null,sort:null,page:null}),loadBooks()})}async function loadBooks(){const e=document.getElementById("books-grid"),t=document.getElementById("results-count");e.innerHTML='<div class="loading">Loading books...</div>',t.textContent="Loading...";try{const n=new URLSearchParams({page:currentPage,limit:20,sort:currentSort});currentGenre&&n.append("genre",currentGenre),currentSearch&&n.append("search",currentSearch);const a=await fetch(`/api/bookshelf/books?${n.toString()}`),r=await a.json();if(!r.success)throw new Error(r.error||"Failed to load books");r.config&&r.config.amazon_affiliate_tag&&(AMAZON_AFFILIATE_TAG=r.config.amazon_affiliate_tag),totalPages=r.pagination.pages;const{total:o,page:c,limit:l}=r.pagination,s=(c-1)*l+1,d=Math.min(c*l,o);t.textContent=0===o?"No books found":`Showing ${s}-${d} of ${o} books`,e.innerHTML="",0===r.books.length?e.innerHTML='<p class="no-books">No books found matching your filters. Try adjusting your search or genre selection.</p>':r.books.forEach(t=>{e.appendChild(createBookCard(t))}),renderPagination(r.pagination),window.scrollTo({top:0,behavior:"smooth"})}catch(n){console.error("Failed to load books:",n),e.innerHTML='<p class="error">Failed to load books. Please try again later.</p>',t.textContent="Error loading books"}}function renderPagination(e){const t=document.getElementById("pagination");if(t.innerHTML="",e.pages<=1)return;const{page:n,pages:a}=e,r=document.createElement("button");r.className="page-btn",r.textContent="← Previous",r.disabled=1===n,r.addEventListener("click",()=>{n>1&&(currentPage=n-1,updateUrlParams({page:currentPage}),loadBooks())}),t.appendChild(r);let o=Math.max(1,n-Math.floor(3.5)),c=Math.min(a,o+7-1);if(c-o<6&&(o=Math.max(1,c-7+1)),o>1){const e=createPageButton(1,n);if(t.appendChild(e),o>2){const e=document.createElement("span");e.textContent="...",e.style.padding="10px",t.appendChild(e)}}for(let e=o;e<=c;e++){const a=createPageButton(e,n);t.appendChild(a)}if(c<a){if(c<a-1){const e=document.createElement("span");e.textContent="...",e.style.padding="10px",t.appendChild(e)}const e=createPageButton(a,n);t.appendChild(e)}const l=document.createElement("button");l.className="page-btn",l.textContent="Next →",l.disabled=n===a,l.addEventListener("click",()=>{n<a&&(currentPage=n+1,updateUrlParams({page:currentPage}),loadBooks())}),t.appendChild(l)}function createPageButton(e,t){const n=document.createElement("button");return n.className="page-btn",n.textContent=e,e===t&&n.classList.add("active"),n.addEventListener("click",()=>{window.currentPage=e,updateUrlParams({page:e}),loadBooks()}),n}function setupSidebarToggle(){const e=document.getElementById("browse-sidebar"),t=document.querySelector(".browse-layout"),n=document.getElementById("sidebar-toggle");"true"===localStorage.getItem("sidebarCollapsed")&&(e.classList.add("collapsed"),t.classList.add("sidebar-collapsed")),n.addEventListener("click",()=>{const n=e.classList.toggle("collapsed");t.classList.toggle("sidebar-collapsed"),localStorage.setItem("sidebarCollapsed",n)})}document.addEventListener("DOMContentLoaded",()=>{if(currentGenre=getUrlParam("genre"),currentSearch=getUrlParam("search")||"",currentSort=getUrlParam("sort")||"latest",currentPage=parseInt(getUrlParam("page"))||1,currentGenre){const e=document.querySelector(`input[name="genre"][value="${currentGenre}"]`);e&&(e.checked=!0,document.querySelector('input[name="genre"][value="all"]').checked=!1)}currentSearch&&(document.getElementById("search-input").value=currentSearch),currentSort&&(document.getElementById("sort-select").value=currentSort),setupEventListeners(),setupSidebarToggle(),loadBooks()});