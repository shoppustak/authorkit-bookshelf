let AMAZON_AFFILIATE_TAG="minihover-21";const viewedBooks=new Set,viewObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target.dataset.bookId;t&&!viewedBooks.has(t)&&(viewedBooks.add(t),trackBookView(t))}})},{threshold:.5,rootMargin:"0px"});async function trackBookView(e){try{await fetch("/api/bookshelf/track-view",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({book_id:e})})}catch(e){console.debug("Failed to track view:",e)}}function createBookCard(e){const t=document.createElement("div");t.className="book-card",t.dataset.bookId=e.id;const n=document.createElement("div");n.className="book-cover-wrapper";const o=document.createElement("img");if(o.src=e.cover.medium||e.cover.large||"/images/placeholder-book.jpg",o.alt=e.title,o.className="book-cover",o.loading="lazy",n.appendChild(o),e.view_count&&e.view_count>0){const t=document.createElement("div");t.className="view-count-badge",t.innerHTML=`\n            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>\n                <circle cx="12" cy="12" r="3"></circle>\n            </svg>\n            <span>${formatViewCount(e.view_count)}</span>\n        `,n.appendChild(t)}t.appendChild(n);const r=document.createElement("div");r.className="book-info";const a=document.createElement("h3");a.className="book-title",a.textContent=e.title,r.appendChild(a);const i=document.createElement("p");if(i.className="book-author",i.textContent=`by ${e.author.name||"Unknown Author"}`,r.appendChild(i),e.genres&&e.genres.length>0){const t=document.createElement("div");t.className="book-genres",e.genres.forEach(e=>{const n=document.createElement("span");n.className="genre-badge",n.textContent=formatGenreName(e),t.appendChild(n)}),r.appendChild(t)}if(e.rating&&e.rating>0){const t=document.createElement("div");t.className="book-rating";const n=document.createElement("span");n.className="stars",n.textContent=getStarRating(e.rating),t.appendChild(n);const o=document.createElement("span");o.textContent=`${e.rating} (${e.review_count||0} reviews)`,t.appendChild(o),r.appendChild(t)}const c=document.createElement("div");c.className="book-actions";const s=e.purchase_links.amazon_com||e.purchase_links.amazon_in,l=e.purchase_links.other;if(s||l){const e=document.createElement("a");e.href=s?addAffiliateTag(s):l,e.textContent=s?"Buy on Amazon":"Buy Book",e.className="btn-buy",e.target="_blank",e.rel="noopener noreferrer nofollow",c.appendChild(e)}const d=document.createElement("a"),u=e.source_post_id?`${e.author.site_url}/?p=${e.source_post_id}`:e.slug?`${e.author.site_url}/book/${e.slug}/`:e.author.site_url;return d.href=u,d.className="btn-view-site",d.target="_blank",d.rel="noopener noreferrer",d.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>',d.title="View on author's site",c.appendChild(d),r.appendChild(c),t.appendChild(r),viewObserver.observe(t),t}function formatGenreName(e){return{"action-adventure":"Action & Adventure",childrens:"Children's Books",fantasy:"Fantasy","historical-fiction":"Historical Fiction",horror:"Horror","literary-fiction":"Literary Fiction","mystery-crime":"Mystery & Crime","non-fiction":"Non-Fiction",poetry:"Poetry",romance:"Romance","science-fiction":"Science Fiction","self-help":"Self-Help","thriller-suspense":"Thriller & Suspense","young-adult":"Young Adult",other:"Other"}[e]||e}function getStarRating(e){const t=Math.floor(e),n=e%1>=.5,o=5-t-(n?1:0);return"★".repeat(t)+(n?"½":"")+"☆".repeat(o)}function addAffiliateTag(e){if(!e)return"";try{const t=new URL(e);return t.hostname.includes("amazon.")?(t.searchParams.set("tag",AMAZON_AFFILIATE_TAG),t.toString()):e}catch(t){return console.error("Invalid URL:",e),e}}function getUrlParam(e){return new URLSearchParams(window.location.search).get(e)}function updateUrlParams(e){const t=new URLSearchParams(window.location.search);Object.keys(e).forEach(n=>{e[n]?t.set(n,e[n]):t.delete(n)});const n=`${window.location.pathname}?${t.toString()}`;window.history.pushState({},"",n)}function debounce(e,t){let n;return function(...o){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...o)},t)}}function formatViewCount(e){return e>=1e3?(e/1e3).toFixed(1).replace(/\.0$/,"")+"K":e.toString()}